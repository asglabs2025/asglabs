---
- name: Ubuntu OS patching and hardening with unified logging
  hosts: ubuntu
  become: yes
  gather_facts: yes

  vars:
    log_dir: "~/git/homelab-infra-priv/ansible/logs/ubuntu"

  pre_tasks:
    - name: Generate shared run ID
      ansible.builtin.set_fact:
        shared_run_id: "{{ lookup('pipe', 'date +%Y%m%dT%H%M%S') }}"
      delegate_to: localhost
      run_once: true

    - name: Ensure log directory exists
      ansible.builtin.file:
        path: "{{ log_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true
      become: false

    - name: Set log file path
      ansible.builtin.set_fact:
        log_file: "{{ log_dir }}/ubuntu_patch_{{ hostvars['localhost']['shared_run_id'] | default(shared_run_id, true) }}.log"

    - name: Ensure log file exists
      ansible.builtin.file:
        path: "{{ log_file }}"
        state: touch
        mode: '0644'
      delegate_to: localhost
      become: false

    - name: Log start of patching
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] Starting Ubuntu patch for {{ inventory_hostname }}"
      delegate_to: localhost
      become: false

    - name: CVE scan before patching
      ansible.builtin.shell: apt list --upgradable
      register: cve_before
      changed_when: false

    - name: Log CVE scan before patching
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} CVE check before patching: {{ cve_before.stdout | replace('\n','; ') }}"
      delegate_to: localhost
      become: false

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
      register: update_result

    - name: Log apt cache update result
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} updated apt cache. Changed: {{ update_result.changed }}"
      delegate_to: localhost
      become: false

    - name: Upgrade system packages
      ansible.builtin.apt:
        upgrade: dist
      register: upgrade_result

    - name: Log upgrade result
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} upgraded packages. Changed: {{ upgrade_result.changed }}"
      delegate_to: localhost
      become: false

    - name: CVE scan after patching
      ansible.builtin.shell: apt list --upgradable
      register: cve_after
      changed_when: false

    - name: Log CVE scan after patching
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} CVE check after patching: {{ cve_after.stdout | replace('\n','; ') }}"
      delegate_to: localhost
      become: false

    #### Security hardening steps ####

    - name: Disable root SSH login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin no'
        create: yes
      register: harden_root_login

    - name: Log root SSH hardening
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} hardening: PermitRootLogin set to no. Changed: {{ harden_root_login.changed }}"
      delegate_to: localhost
      become: false

    - name: Restart SSH if root login hardening changed
      ansible.builtin.service:
        name: ssh
        state: restarted
      when: harden_root_login.changed

    - name: Disable password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PasswordAuthentication'
        line: 'PasswordAuthentication no'
        create: yes
      register: harden_password_auth

    - name: Log password authentication hardening
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} hardening: PasswordAuthentication set to no. Changed: {{ harden_password_auth.changed }}"
      delegate_to: localhost
      become: false

    - name: Restart SSH if password authentication hardening changed
      ansible.builtin.service:
        name: ssh
        state: restarted
      when: harden_password_auth.changed

    #### End security hardening ####

    - name: Reboot if needed
      ansible.builtin.reboot:
        msg: "Rebooting after patching"
        connect_timeout: 5
        reboot_timeout: 600
        pre_reboot_delay: 0
        post_reboot_delay: 30
      when: upgrade_result.changed

    - name: Log reboot
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} rebooted."
      when: upgrade_result.changed
      delegate_to: localhost
      become: false

    - name: Log patch summary
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] âœ… {{ inventory_hostname }} patch and hardening completed. Packages changed: {{ upgrade_result.changed | ternary('Yes', 'No') }}"
      delegate_to: localhost
      become: false
