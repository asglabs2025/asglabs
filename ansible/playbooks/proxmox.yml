---
- name: Proxmox OS & package patching with unified logging
  hosts: proxmox
  become: yes
  gather_facts: yes

  vars:
    log_dir: "~/git/homelab-infra-priv/ansible/logs/proxmox"

  pre_tasks:
    - name: Generate shared run ID
      ansible.builtin.set_fact:
        shared_run_id: "{{ lookup('pipe', 'date +%Y%m%dT%H%M%S') }}"
      delegate_to: localhost
      run_once: true

    - name: Ensure log directory exists
      ansible.builtin.file:
        path: "{{ log_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true
      become: false

    - name: Set log file path
      ansible.builtin.set_fact:
        log_file: "{{ log_dir }}/proxmox_patch_{{ hostvars['localhost']['shared_run_id'] }}.log"

    - name: Ensure log file exists
      ansible.builtin.file:
        path: "{{ log_file }}"
        state: touch
        mode: '0644'
      delegate_to: localhost
      become: false

    - name: Log start of Proxmox patching
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] Starting Proxmox patch for {{ inventory_hostname }}"
      delegate_to: localhost
      become: false

    - name: CVE scan before patching
      ansible.builtin.shell: apt list --upgradable
      register: cve_before
      changed_when: false

    - name: Log CVE scan before patching
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} CVE before: {{ cve_before.stdout | replace('\n','; ') }}"
      delegate_to: localhost
      become: false

  tasks:

    ######################################################################
    # Fix Proxmox enterprise repo if it exists (common cause of apt fail)
    ######################################################################
    - name: Disable Proxmox Enterprise repo if present
      ansible.builtin.replace:
        path: /etc/apt/sources.list.d/pve-enterprise.list
        regexp: '^deb'
        replace: '# deb'
      ignore_errors: true

    ######################################################################
    # Ensure no-subscription repo is enabled
    ######################################################################
    - name: Ensure Proxmox no-subscription repo is enabled
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-no-subscription.list
        mode: '0644'
        content: |
          deb http://download.proxmox.com/debian/pve {{ ansible_distribution_release }} pve-no-subscription

    ######################################################################
    # Update and upgrade package lists
    ######################################################################
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
      register: update_result

    - name: Log apt cache update result
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} updated apt cache. Changed: {{ update_result.changed }}"
      delegate_to: localhost
      become: false

    - name: Upgrade system packages (dist-upgrade)
      ansible.builtin.apt:
        upgrade: dist
      register: upgrade_result

    - name: Log upgrade result
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} upgraded packages. Changed: {{ upgrade_result.changed }}"
      delegate_to: localhost
      become: false

    ######################################################################
    # Proxmox-specific full upgrade
    ######################################################################
    - name: Run pveupgrade (Proxmox kernel & packages)
      ansible.builtin.command: pveupgrade
      register: pveupgrade_result
      changed_when: "'upgraded' in pveupgrade_result.stdout or 'upgrade' in pveupgrade_result.stdout"

    - name: Log pveupgrade result
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} ran pveupgrade."
      delegate_to: localhost
      become: false

    ######################################################################
    # Final CVE check
    ######################################################################
    - name: CVE scan after patching
      ansible.builtin.shell: apt list --upgradable
      register: cve_after
      changed_when: false

    - name: Log CVE after scan
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} CVE after: {{ cve_after.stdout | replace('\n','; ') }}"
      delegate_to: localhost
      become: false

    ######################################################################
    # Cleanup & reboot
    ######################################################################
    - name: Autoremove
      ansible.builtin.apt:
        autoremove: yes
      register: autoremove_result

    - name: Log autoremove result
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} autoremove. Changed: {{ autoremove_result.changed }}"
      delegate_to: localhost
      become: false

    - name: Reboot Proxmox node if needed
      ansible.builtin.reboot:
        msg: "Rebooting after Proxmox patching"
        connect_timeout: 5
        reboot_timeout: 600
        post_reboot_delay: 30
      when: upgrade_result.changed or pveupgrade_result.changed

    - name: Log reboot event
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] {{ inventory_hostname }} rebooted."
      when: upgrade_result.changed or pveupgrade_result.changed
      delegate_to: localhost
      become: false

    - name: Log final summary
      ansible.builtin.lineinfile:
        path: "{{ log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] âœ… {{ inventory_hostname }} Proxmox patch completed. Changed: {{ upgrade_result.changed }}"
      delegate_to: localhost
      become: false
